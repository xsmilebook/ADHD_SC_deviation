---
title: "PKU6_exclusion"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(psych)
library(MplusAutomation)
library(openxlsx)
library(rjson)
library(readxl)
library(stringr)
demo_path <- "D:/code/ADHD_SC_deviation/data/demography/PKU6"
qcpath <- "D:/xuxiaoyu/open_dataset_information/PKU6/qc_json"

file_path <- paste0(demo_path, "/20250421_ADHD_NC_demo_adhdrs_cantab_forCIBR.xlsx")

basic_demo.ADHD <- read_excel(file_path, sheet = "ADHD_demo")
basic_demo.NC <- read_excel(file_path, sheet = "NC_demo")
basic_demo.df <- bind_rows(
  basic_demo.ADHD %>% mutate(ADHD = 1),
  basic_demo.NC %>% mutate(ADHD = 0)
)

basic_demo.df <- basic_demo.df %>% mutate(
  age = case_when(
    is.na(`age(m)`) ~ as.numeric(`age (month)`) / 12,
    .default = as.numeric(`age(m)`) / 12
  )
)
summary(basic_demo.df$age)

basic_demo.df <- basic_demo.df %>% select(-`age(m)`, -`age (month)`)
basic_demo.df <- basic_demo.df %>% dplyr::rename(ID = id)

basic_demo.df$sex <- ifelse(basic_demo.df$sex == "1", "M", "F")
print(paste("start: ", nrow(basic_demo.df))) # 689

## Treatment
basic_treatment <- read.xlsx(paste0(demo_path, "/20250914_treatment_check.xlsx"))

```


### 1) Subjects with MRI data
```{r MRI}

qcfiles <- list.files(path = qcpath, recursive = T)
MRsublist<- gsub(".json", "", qcfiles)
MRsublist.df <- data.frame(subID=MRsublist)
MRsublist.df$ID <- sub("^sub-(.+)$", "\\1", MRsublist)

basic_demo.df <- basic_demo.df[basic_demo.df$ID %in% MRsublist.df$ID, ]
print(paste("subject with MRI: ", nrow(basic_demo.df))) # 601
basic_demo.df <- basic_demo.df %>%
  left_join(MRsublist.df, by = "ID")

```

### 2) Sensory issues
The exclusion criteria of HBN including hearing or visual impairment that prevents participation in study-released tasks. No more exclusion for sensory issues in this study.
There is no relevent information in PKU6

### 3) Intellectual disability

Only participants with IQ over 70 were included.
There is no IQ info in PKU6

### 4) Major medical or neurological conditions

Children with Congenital_heartDisease were excluded.
PKU6: skip


### 5) Age & Sex

```{r agesex}

basic_demo.df <- basic_demo.df %>% 
  filter(!is.na(sex) & !is.na(age))

print(paste("filter subject without age and sex: ", nrow(basic_demo.df))) # 571

```
### 6) MRI qc

```{r MRIqc}

basic_demo.df$mean_fd <- NA_real_
for (i in 1:nrow(basic_demo.df)){
  subIDtmp <- paste0("sub-", basic_demo.df$ID[i])
  filename <- paste0(qcpath, "/",subIDtmp, ".json" )
  if (file.exists(filename)){
    qcjson <- rjson::fromJSON(file=filename)
    basic_demo.df$mean_fd[i] <- qcjson$subjects[[1]]$mean_fd
  }
}

basic_demo.df <- basic_demo.df %>% filter(mean_fd < mean(mean_fd)+3*sd(mean_fd))

print(paste("filter subject with fd: ", nrow(basic_demo.df))) # 561


```


### Merge treatment

```{r treatment}

basic_demo.df <- basic_demo.df %>%
  left_join(
    basic_treatment %>% dplyr::rename(ID = id),
    by = "ID"
  )


```


### Merge ICV

```{r ICV}
ICV_BP <- read.csv(paste0(demo_path, "/ICV_PKU6.txt"), header = F)
ICV_BP$V3 <- NULL
names(ICV_BP) <- c("subID", "ICV")

basic_demo.df <- basic_demo.df %>% left_join(ICV_BP, by=c("ID"="subID"))



write.csv(basic_demo.df, paste0(result_path, "/basic_demo_merge.csv"), row.names = F)

```


```{r}

basic_demo.df <- basic_demo.df %>% mutate(
  IA_B = case_when(is.na(IA_B)~`IA-3`,
                   .default = IA_B),
  HI_B = case_when(is.na(HI_B)~`HI-3`,
                   .default = HI_B),
  TO_B = case_when(is.na(TO_B)~`TO-3`,
                   .default = TO_B)
)

basic_demo.df <- basic_demo.df %>% select(-`IA-3`, -`HI-3`, -`TO-3`)

basic_demo.df$medication[basic_demo.df$medication == "AXT"] <- "ATX"  
write.csv(basic_demo.df, paste0(result_path, "/basic_demo_PKU6.csv"), row.names = F)


```

## Add EFNY

```{r}

basic_demo.df.PKU6 <- read.csv("D:/xuxiaoyu/open_dataset_information/PKU6/basic_demo_PKU6.csv")
basic_demo.df.EFNY <- read.csv("D:/xuxiaoyu/project_files/BP_youth_data/demography/basic_demo_merge_screen.csv")

basic_demo.df.PKU6$site <- "PKU6"
basic_demo.df.PKU6$ID <- paste0("sub-", basic_demo.df.PKU6$ID)
basic_demo.df.EFNY$site <- "EFNY"
basic_demo.df.EFNY$ID <- basic_demo.df.EFNY$subID
basic_demo.df.EFNY$sex <- basic_demo.df.EFNY$Sex

Behavior <- rbind(basic_demo.df.PKU6[,c("ID", "mean_fd", "age", "sex", "ADHD", "ICV", "site")],
                  basic_demo.df.EFNY[,c("ID", "mean_fd", "age", "sex", "ADHD", "ICV", "site")])

write.csv(Behavior, "D:/xuxiaoyu/DMRI_network_development/Normative_model/demography/ALL_SITES_basic_demo.csv", row.names = F)

```



